#!/usr/bin/env ruby
# frozen_string_literal: true

# Aggregates per-implementation result files into per-benchmark JSON files
# for the website. Run before building/serving the website.
#
# Usage: bundle exec ruby bin/aggregate_results <output_dir>
# Example: bundle exec ruby bin/aggregate_results website/public/data

require 'json'
require 'fileutils'
require_relative '../config'

output_dir = ARGV[0] || 'website/public/data'
FileUtils.mkdir_p(output_dir)

# For each benchmark, collect results and aggregates from all implementation files
Config.benchmarks.each do |benchmark_id|
  results = []
  aggregates = {}

  Dir.glob("#{Config.results_dir}/*.json").each do |file|
    data = JSON.parse(File.read(file))
    benchmark_data = data[benchmark_id]
    next unless benchmark_data

    implementation = data['implementation']
    next unless implementation

    results.concat(benchmark_data['results'] || [])
    aggregates[implementation] = benchmark_data['aggregate'] if benchmark_data['aggregate']
  rescue JSON::ParserError
    next
  end

  next if results.empty? && aggregates.empty?

  output = { 'results' => results, 'aggregates' => aggregates }
  output_file = File.join(output_dir, "#{benchmark_id}.json")
  File.write(output_file, JSON.pretty_generate(output))
  puts "Wrote #{output_file} (#{aggregates.size} implementations)"
end

puts "Done. Output written to #{output_dir}/"
